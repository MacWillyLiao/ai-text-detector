<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI文本檢測系統</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            background-color: #f5f5f5;
        }
        
        .container {
            display: flex;
            width: 100%;
            height: 100%;
        }
        
        .info-panel {
            flex: 1;
            background-color: #fff;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e0e0e0;
        }
        
        .content-panel {
            flex: 2;
            display: flex;
            flex-direction: column;
        }
        
        .input-area {
            flex: 1;
            padding: 20px;
            background-color: #fff;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
        }
        
        .result-area {
            flex: 1;
            padding: 20px;
            background-color: #fff;
            overflow-y: auto;
        }
        
        .slider-container {
            margin-bottom: 30px;
        }
        
        .slider {
            width: 100%;
            margin-top: 10px;
        }
        
        .ai-percentage {
            margin: 20px 0;
            text-align: center;
        }
        
        .percentage-value {
            font-size: 36px;
            font-weight: bold;
            color: #d32f2f;
        }
        
        .sentence-list {
            margin-top: 20px;
            flex-grow: 1;
            overflow-y: auto;
        }
        
        .sentence-item {
            padding: 10px;
            margin-bottom: 5px;
            border-left: 4px solid #d32f2f;
            background-color: #ffebee;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .sentence-item:hover {
            background-color: #ffcdd2;
        }
        
        .sentence-prob {
            float: right;
            font-weight: bold;
        }
        
        textarea {
            width: 100%;
            height: 100%;
            border: 1px solid #ddd;
            padding: 10px;
            box-sizing: border-box;
            resize: none;
            font-size: 16px;
            font-family: inherit;
        }
        
        button {
            padding: 10px 20px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #0b7dda;
        }
        
        .highlight {
            background-color: #ffcdd2;
            padding: 2px 0;
        }
        
        .result-text {
            line-height: 1.6;
            font-size: 16px;
        }
        
        .progress-ring {
            width: 120px;
            height: 120px;
            margin: 0 auto;
            position: relative;
        }
        
        .progress-ring__circle {
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            stroke-dasharray: 283;
            transition: stroke-dashoffset 0.3s ease;
        }
        
        .progress-ring__text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: bold;
        }
        
        .header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        
        .detail-level {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            color: #666;
        }

        .loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #2196f3;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="info-panel">
            <div class="header">AI文本檢測結果</div>
            
            <div class="slider-container">
                <div>細節程度（建議修改的地方）</div>
                <input type="range" min="0" max="0.025" step="0.00001" value="0" class="slider" id="detailSlider">
                <div class="detail-level">
                    <span>低（不顯示）</span>
                    <span>高（更細節）</span>
                </div>
            </div>
            
            <div class="ai-percentage">
                <div>AI生成句子佔比</div>
                <div class="progress-ring">
                    <svg width="120" height="120" viewBox="0 0 120 120">
                        <circle cx="60" cy="60" r="45" fill="none" stroke="#e0e0e0" stroke-width="8"/>
                        <circle id="progressRing" cx="60" cy="60" r="45" fill="none" stroke="#d32f2f" stroke-width="8" class="progress-ring__circle" stroke-dashoffset="283"/>
                    </svg>
                    <div class="progress-ring__text" id="percentageText">0%</div>
                </div>
            </div>
            
            <div>
                <div class="header">AI生成句子排行</div>
                <div class="sentence-list" id="sentenceList">
                    <!-- 這裡會動態填充AI生成句子排行 -->
                </div>
            </div>
        </div>
        
        <div class="content-panel">
            <div class="input-area">
                <div class="header">輸入文本</div>
                <textarea id="inputText" placeholder="請在此處貼上需要檢測的文本..."></textarea>
                <button id="analyzeBtn">分析文本</button>
                <div class="loading" id="loadingIndicator">
                    <div class="spinner"></div>
                    <p>正在分析中，請稍候...</p>
                </div>
            </div>
            
            <div class="result-area">
                <div class="header">檢測結果</div>
                <div class="result-text" id="resultText">
                    <!-- 這裡會顯示標記後的文本 -->
                    分析結果將在這裡顯示...
                </div>
                <div id="executionTime" style="margin-top: 10px; color: #555;"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const inputText = document.getElementById('inputText');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const resultText = document.getElementById('resultText');
            const sentenceList = document.getElementById('sentenceList');
            const progressRing = document.getElementById('progressRing');
            const percentageText = document.getElementById('percentageText');
            const detailSlider = document.getElementById('detailSlider');
            const loadingIndicator = document.getElementById('loadingIndicator');
            
            // 設置環形進度條的初始狀態
            const circle = progressRing;
            const radius = circle.r.baseVal.value;
            const circumference = radius * 2 * Math.PI;
            circle.style.strokeDasharray = `${circumference} ${circumference}`;
            circle.style.strokeDashoffset = circumference;
            
            function setProgress(percent) {
                const offset = circumference - (percent / 100) * circumference;
                circle.style.strokeDashoffset = offset;
                percentageText.textContent = `${percent}%`;
            }
            
            analyzeBtn.addEventListener('click', function() {
                const text = inputText.value.trim();
                if (text === '') {
                    alert('請輸入需要分析的文本');
                    return;
                }
                
                const startTime = performance.now();

                // 顯示載入指示器
                loadingIndicator.style.display = 'block';

                setTimeout(async () => {
                    const analysisResult = await mockAnalyzeText(text, detailSlider.value);

                    updateResults(analysisResult);

                    const endTime = performance.now();
                    const duration = ((endTime - startTime) / 1000).toFixed(2);
                    document.getElementById('executionTime').textContent = `執行時間：${duration} 秒`;

                    loadingIndicator.style.display = 'none';
                }, 1500);
            });
            
            detailSlider.addEventListener('input', function() {
                if (inputText.value.trim() !== '' && resultText.textContent !== '分析結果將在這裡顯示...') {
                    const analysisResult = mockAnalyzeText(inputText.value.trim(), this.value);
                    updateResults(analysisResult);
                }
            });
            
            function updateResults(result) {
                // 更新百分比
                setProgress(result.aiPercentage);
                
                // 更新結果文本
                resultText.innerHTML = '';

                result.sentences.forEach((sentence, idx) => {
                    const sliderThreshold = parseFloat(detailSlider.value); // 0 ~ 1
                    const sentenceWrapper = document.createElement('span');
                    sentenceWrapper.setAttribute('data-sentence-id', `sentence-${idx}`);

                    if (sliderThreshold === 0 && sentence.isAI) {
                        sentenceWrapper.textContent = sentence.text;
                        if (sentence.isAI) sentenceWrapper.className = 'highlight';
                    } else {
                        // 有 tokens 且 sliderThreshold > 0，逐 token 標記
                        sentence.tokens.forEach(({ token, score }) => {
                            const tokenSpan = document.createElement('span');
                            tokenSpan.textContent = token;

                            if (sentence.isAI && score > sliderThreshold) {
                                tokenSpan.className = 'highlight';
                            }

                            sentenceWrapper.appendChild(tokenSpan);
                        });
                    }

                    resultText.appendChild(sentenceWrapper);
                    resultText.appendChild(document.createTextNode(' ')); // 句子之間空格
                });
                
                // 更新AI句子排行
                sentenceList.innerHTML = '';
                
                const aiSentences = result.sentences
                    .filter(s => s.isAI && s.probability > 0.5)
                    .sort((a, b) => b.probability - a.probability);
                
                aiSentences.forEach((sentence, index) => {
                    const div = document.createElement('div');
                    div.className = 'sentence-item';
                    div.innerHTML = `
                        <span>${sentence.text.substring(0, 30)}${sentence.text.length > 30 ? '...' : ''}</span>
                        <span class="sentence-prob">${Math.round(sentence.probability * 100)}%</span>
                    `;

                    div.addEventListener('click', function() {
                        const sentenceWrappers = resultText.querySelectorAll('[data-sentence-id]');
                        const idx = result.sentences.indexOf(sentence);
                        const targetSpan = resultText.querySelector(`[data-sentence-id="sentence-${idx}"]`);
                        if (targetSpan) {
                            targetSpan.scrollIntoView({ behavior: 'smooth', block: 'center' });

                            // 添加閃爍動畫
                            targetSpan.style.transition = 'background-color 0.3s';
                            const originalBg = targetSpan.style.backgroundColor;
                            targetSpan.style.backgroundColor = '#ff5252';
                            setTimeout(() => {
                                targetSpan.style.backgroundColor = originalBg || '';
                            }, 1000);
                        }
                    });
                    
                    sentenceList.appendChild(div);
                });
            }
            
            // 後端 API 分析文本
            async function mockAnalyzeText(text, detailLevel) {
                // 將文本分割成句子
                const cleanedText = text.replace(/[\s\r]+/g, '');
                const sentenceRegex = /[^。]*(?:。(?=[^」）」”）]|$)|[^。]+$)/g;
                const sentencesMatch = cleanedText.match(sentenceRegex) || [cleanedText];

                const sentences = [];
                let aiCount = 0;

                for (const [index, s] of sentencesMatch.entries()) {

                    /*
                    後端 (backend.ipynb) 執行完會有一個 ngrok 網址 (每次執行都不一樣)。
                    每次打開網頁 (frontend.html) 前記得改 ngrok 網址，因為免費版會變動。
                    "/process" 是後端 Flask API 的路徑，記得留著，只改網址就行了。
                    */
                    const response = await fetch('Your Ngork URL/process', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ text: s })
                    });

                    const data = await response.json();
                    const prediction = data.prediction;
                    const probability = data.probability;
                    const tokens = data.tokens;

                    console.log(`Prediction: ${prediction}`);
                    console.log(`Probability: ${probability}`);
                    console.log('Tokens:');
                    tokens.forEach(item => {
                        console.log(`  ${item.token}: ${item.score.toFixed(4)}`);
                    });

                    if (prediction) {
                        aiCount++;
                    }

                    sentences.push({
                        text: s.trim(),
                        isAI: Boolean(prediction),
                        probability: probability,
                        tokens: tokens
                    });
                }
                
                // 計算AI文本佔比
                const aiPercentage = Math.round((aiCount / sentences.length) * 100);
                
                return {
                    aiPercentage: aiPercentage,
                    sentences: sentences
                };
            }
        });
    </script>
</body>
</html>